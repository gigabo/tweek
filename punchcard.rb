

class PunchCard

  def initialize(dates)
    @dates = dates
  end
  def url
    return @url if @url

    base = 'http://chart.apis.google.com/chart?'

    x_coords = []
    y_coords = []
    (0..7).each do |y|
      (0..23).each do |x|
        x_coords.push(x)
        y_coords.push(y)
      end
    end

    values = grind_values

    params = {
      :chs => '800x300',
      :chds => '-1,24,-1,7,0,22',
      :chf => 'bg,s,e0e0e0',
      :chxt => 'x,y',
      :chm => 'o,333333,1,1.0,25.0',
      :chxl => [
        '0:||12am|1|2|3|4|5|6|7|8|9|10|11|12pm|1|2|3|4|5|6|7|8|9|10|11||',
        '1:||Sun|Mon|Tue|Wed|Thr|Fri|Sat|'
      ].join(''),
      :cht => 's',

      :chd => 't:'+ [
        x_coords.join(','), y_coords.join(','), values
      ].join('|')
    }

    @url = base + params.each_pair do |key, value|
      [key.to_s, value]
    end.collect { |tuple| tuple.join('=') }.join('&')
  end

  private

  def grind_values

    matrix = (0..7).collect { (0..23).collect{0} }
    @dates.each do |date|
      matrix[date.wday][date.hour] += 1;
    end
    max = matrix.inject(0) do |m1,a|
      v1 = a.inject(0) do |m2,v2|
        v2 > m2 ? v2 : m2
      end
      v1 > m1 ? v1 : m1
    end

    scale = max > 0 ? (24 / max) : 0

    values = []
    (0..7).each do |y|
      (0..23).each do |x|
        values.push(matrix[y][x] * scale)
      end
    end
    values.join(',')
  end
end

def PunchCard.fake
  'http://chart.apis.google.com/chart?chm=o,333333,1,1.0,25.0&chxl=0:||12am|1|2|3|4|5|6|7|8|9|10|11|12pm|1|2|3|4|5|6|7|8|9|10|11||1:||Sun|Mon|Tue|Wed|Thr|Fri|Sat|&chs=800x300&cht=s&chds=-1,24,-1,7,0,22&chd=t:0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23|0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7|0,0,0,0,0,0,0,0,2,0,0,4,0,0,2,4,2,4,0,4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,4,4,14,4,0,2,4,2,4,8,4,8,4,8,0,0,0,0,0,0,0,10,2,10,20,10,0,0,2,4,0,4,2,4,2,4,4,0,0,0,0,0,0,4,0,2,4,2,12,12,10,6,4,8,6,0,2,2,8,2,2,0,0,0,0,0,0,0,2,2,0,2,2,4,2,0,0,0,0,4,0,8,4,2,4,10,0,0,0,0,0,2,2,0,0,0,0,0,0,0,0,2,0,0,0,0,0,4,2,2,0,0,0,0,0,0,0,0,0,0,2,0,6,0,2,0,2,0,4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0&chf=bg,s,e0e0e0&chxt=x,y'
end
